
sequenceDiagram
    participant U as User
    participant W as Webview (React)
    participant E as Extension Host
    participant H as HookEngine (PreHook/PostHook)
    participant L as LLM (Reasoning only)
    participant T as Tool (Deterministic PONR)
    participant D as Ledger (agent_trace.jsonl)

    U->>W: Types request (goal/intent)
    W->>E: postMessage({ type: "ask", payload })
    E->>H: executeWithHooks(payload)

    H->>H: PreHook: validate intent_id & scope

    alt Intent missing or invalid
        H-->>E: Block execution (error)
        E-->>W: Notify (select/confirm intent)
    else Intent valid
        H->>L: Invoke with enriched context (intent, sidecar constraints)
        L-->>H: Reasoning output (planned tool calls, reasoning trace)
        H->>T: Execute Tool (deterministic, based on LLM plan)
        T-->>H: Result (outputs, affected files)
        H->>H: PostHook: compute SHA-256 content_hash, extract AST
        H->>D: Append trace entry (intent_id, reasoning_id, content_hash, AST, git_revision)
        H-->>E: Success (trace id)
        E-->>W: Update UI (status, artifacts, trace link)
    end
